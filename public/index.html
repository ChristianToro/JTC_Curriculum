<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curriculum Guest Speaker System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app"></div>

    <script>
        let currentUser = null;
        let authToken = null;
        const API_URL = '/api';
        const socket = new WebSocket('wss://curriculum-organizer.vercel.app'); // Update with your Vercel app URL

        socket.addEventListener('message', function(event) {
            const message = JSON.parse(event.data);
            if (message.type === 'UPDATE') {
                updateCurriculumPage(message.data); // Function to update the page with new data
            }
        });

        function renderLoginPage() {
            document.getElementById('app').innerHTML = `
                <h1>Login</h1>
                <form id="loginForm">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <p>Don't have an account? <a href="#" onclick="renderRegistrationPage()">Register</a></p>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function renderRegistrationPage() {
            document.getElementById('app').innerHTML = `
                <h1>Register</h1>
                <form id="registrationForm">
                    <input type="email" id="regEmail" placeholder="Email" required>
                    <input type="password" id="regPassword" placeholder="Password" required>
                    <input type="text" id="regFullName" placeholder="Full Name" required>
                    <input type="text" id="regTitle" placeholder="Title">
                    <input type="text" id="regCompany" placeholder="Company">
                    <input type="number" id="regExperience" placeholder="Years of Experience">
                    <textarea id="regBio" placeholder="Short Bio"></textarea>
                    <input type="file" id="regProfilePic" accept="image/*">
                    <img id="profilePicPreview" style="display: none;">
                    <button type="submit">Register</button>
                </form>
                <p>Already have an account? <a href="#" onclick="renderLoginPage()">Login</a></p>
            `;
            document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
            document.getElementById('regProfilePic').addEventListener('change', handleProfilePicUpload);
        }

        function renderProfilePage() {
            document.getElementById('app').innerHTML = `
                <div class="nav">
                    <a href="#" onclick="renderCurriculumPage()">View Curriculum</a>
                    <a href="#" onclick="handleLogout()">Logout</a>
                </div>
                <h1>User Profile</h1>
                <form id="profileForm">
                    <img id="profilePicPreview" src="data:${currentUser.profilePic.contentType};base64,${btoa(currentUser.profilePic.data)}" style="display: ${currentUser.profilePic ? 'block' : 'none'}">
                    <input type="file" id="profilePic" accept="image/*">
                    <input type="email" id="email" value="${currentUser.email}" readonly>
                    <input type="text" id="fullName" value="${currentUser.fullName}" required>
                    <input type="text" id="title" value="${currentUser.title || ''}">
                    <input type="text" id="company" value="${currentUser.company || ''}">
                    <input type="number" id="experience" value="${currentUser.experience || ''}" placeholder="Years of Experience">
                    <textarea id="bio" placeholder="Short Bio">${currentUser.bio || ''}</textarea>
                    <button type="submit">Update Profile</button>
                </form>
            `;
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('profilePic').addEventListener('change', handleProfilePicUpload);
        }

        async function renderCurriculumPage() {
            const curriculumData = await fetchWithAuth(`${API_URL}/curriculum`);
            updateCurriculumPage(await curriculumData.json()); // Update the page with fetched data
        }

        function updateCurriculumPage(data) {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = '<h2>Available Lessons</h2>';
            data.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('curriculum-item');
                itemDiv.innerHTML = `
                    <p><strong>Date:</strong> ${new Date(item.date).toLocaleDateString()}</p>
                    <p><strong>Module:</strong> ${item.moduleName}</p>
                    <p><strong>Lesson:</strong> ${item.lessonName}</p>
                    <button onclick="addSpeaker('${item._id}')">Request Lesson</button>
                    ${item.adminConfirmed ? `<p><strong>Confirmed:</strong> ${item.selectedUser ? item.selectedUser.fullName : 'None'}</p>` : ''}
                `;
                appDiv.appendChild(itemDiv);
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    renderCurriculumPage();
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login');
            }
        }

        async function handleRegistration(e) {
            e.preventDefault();
            const newUser = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                fullName: document.getElementById('regFullName').value,
                title: document.getElementById('regTitle').value,
                company: document.getElementById('regCompany').value,
                experience: document.getElementById('regExperience').value,
                bio: document.getElementById('regBio').value,
                profilePic: {
                    data: btoa(document.getElementById('profilePicPreview').src.split(',')[1]), // Convert base64 to binary
                    contentType: document.getElementById('profilePic').files[0].type
                }
            };
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newUser)
                });
                if (response.ok) {
                    alert('Registration successful. Please log in.');
                    renderLoginPage();
                } else {
                    alert('Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('An error occurred during registration');
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const updatedUser = {
                fullName: document.getElementById('fullName').value,
                title: document.getElementById('title').value,
                company: document.getElementById('company').value,
                experience: document.getElementById('experience').value,
                bio: document.getElementById('bio').value,
                profilePic: {
                    data: btoa(document.getElementById('profilePicPreview').src.split(',')[1]), // Convert base64 to binary
                    contentType: document.getElementById('profilePic').files[0].type
                }
            };
            try {
                const response = await fetchWithAuth(`${API_URL}/users/me`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedUser)
                });
                if (response.ok) {
                    currentUser = await response.json();
                    alert('Profile updated successfully');
                } else {
                    alert('Profile update failed');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('An error occurred during profile update');
            }
        }

        function handleProfilePicUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePicPreview').src = e.target.result;
                    document.getElementById('profilePicPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        function handleLogout() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('authToken');
            renderLoginPage();
        }

        async function addSpeaker(itemId) {
            try {
                const response = await fetchWithAuth(`${API_URL}/curriculum/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ $addToSet: { speakers: currentUser.email } })
                });
                if (response.ok) {
                    renderCurriculumPage();
                } else {
                    alert('Failed to add speaker');
                }
            } catch (error) {
                console.error('Add speaker error:', error);
                alert('An error occurred while adding speaker');
            }
        }

        async function removeSpeaker(itemId) {
            try {
                const response = await fetchWithAuth(`${API_URL}/curriculum/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ $pull: { speakers: currentUser.email } })
                });
                if (response.ok) {
                    renderCurriculumPage();
                } else {
                    alert('Failed to remove speaker');
                }
            } catch (error) {
                console.error('Remove speaker error:', error);
                alert('An error occurred while removing speaker');
            }
        }

        async function fetchWithAuth(url, options = {}) {
            if (!authToken) {
                throw new Error('No auth token available');
            }
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${authToken}`
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) {
                // Token expired or invalid
                authToken = null;
                localStorage.removeItem('authToken');
                renderLoginPage();
                throw new Error('Authentication failed');
            }
            return response;
        }

        // Initial render
        authToken = localStorage.getItem('authToken');
        if (authToken) {
            fetchWithAuth(`${API_URL}/users/me`)
                .then(response => response.json())
                .then(user => {
                    currentUser = user;
                    renderCurriculumPage();
                })
                .catch(() => renderLoginPage());
        } else {
            renderLoginPage();
        }
    </script>
</body>
</html>
